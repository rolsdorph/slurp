<html>

<head>
    <title>Hue Metrics Collector</title>
    <script>
        function addAuth(xhrRequest) {
            xhrRequest.setRequestHeader(
                "Authorization",
                `Bearer ${window.localStorage.getItem("authToken")}`
            );
        }

        function extractKeyVals(mappingDivList) {
            return Array.from(mappingDivList.values()).map(mapping => [
                mapping.querySelector("input[name=key]").value,
                mapping.querySelector("input[name=val]").value
            ]);
        }

        // Performs an authenticated GET to the given URL and renders a
        // stringification of each returned element in the target div
        // (expects the GET to return a JSON list).

        // The elements are rendered with id {prefix}+{id}, where id
        // is the "id" field in the returned DTO
        function getAndRender(targetDiv, idPrefix, url) {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                renderJsonList(targetDiv, idPrefix, XHR.response);
            });

            XHR.responseType = "json";
            XHR.open("GET", url);
            addAuth(XHR);
            XHR.send();
        }

        function renderJsonList(target, idPrefix, elements) {
            target.innerHTML = '';

            for (const element of elements) {
                const domNode = document.createElement("div");
                domNode.id = idPrefix + element.id;
                domNode.innerText = JSON.stringify(element);
                target.appendChild(domNode);
            }
        }

        function loadHomes() {
            const targetDiv = document.getElementById("homeList");
            getAndRender(targetDiv, "source-", "/homes");
        }

        function loadSinks() {
            const targetDiv = document.getElementById("influxList");
            getAndRender(targetDiv, "sink-", "/sinks");
        }

        function loadSimpleSources() {
            const targetDiv = document.getElementById("simpleSourceList");
            getAndRender(targetDiv, "source-", "/simpleSources");
        }

        function addSimpleSource(form) {
            const tagMappingDivs = form.querySelector("#tagMappings").querySelectorAll(".mapping");
            const fieldMappingDivs = form.querySelector("#fieldMappings").querySelectorAll(".mapping");

            const tagMappings = extractKeyVals(tagMappingDivs);
            const fieldMappings = extractKeyVals(fieldMappingDivs);

            const XHR = new XMLHttpRequest();
            XHR.addEventListener("load", function (event) {
                if (XHR.status === 201) {
                    loadSimpleSources();
                } else {
                    console.error(`Unexpected status code ${XHR.status}`);
                }
            });

            XHR.addEventListener("error", function (err) {
                console.log(err);
            });

            XHR.responseType = "json";
            XHR.open("POST", "/simpleSources");
            addAuth(XHR);


            const body = new FormData(form);
            body.append("tagMappings", JSON.stringify(tagMappings));
            body.append("fieldMappings", JSON.stringify(fieldMappings));
            XHR.send(body);
        }

        function addHome(form) {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                if (XHR.status === 200) {
                    window.location = XHR.response;
                } else {
                    console.error(`Unexpected status code ${XHR.status}`);
                }
            });

            XHR.addEventListener("error", function (err) {
                console.log(err);
            });

            XHR.responseType = "json";
            XHR.open("POST", "/homes?redirectUrlInBody=true");
            addAuth(XHR);
            XHR.send(new FormData(form));
        }

        let currentlyFlashing = []; // We'll find a cool way to indicate super rapid events later :)
        function flash(elem, color) {
            if (!currentlyFlashing.includes(elem)) {
                currentlyFlashing.push(elem);
                const oldColor = elem.style.backgroundColor;
                elem.style.backgroundColor = color;
                setTimeout(() => {
                    currentlyFlashing = currentlyFlashing.filter(e => e != elem);
                    elem.style.backgroundColor = oldColor;
                }, 500);
            }
        }

        function addSink(form) {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                if (XHR.status === 201) {
                    loadSinks();
                } else {
                    console.error(`Unexpected status code ${XHR.status}`);
                }
            });

            XHR.addEventListener("error", function (err) {
                console.log(err);
            });

            XHR.responseType = "json";
            XHR.open("POST", "/sinks");
            addAuth(XHR);
            XHR.send(new FormData(form));
        }

        function addMapping(container, e) {
            e.preventDefault();
            const targetDiv = container.parentElement.querySelector(".mappings");

            const keyInput = document.createElement("input");
            keyInput.type = "text";
            keyInput.name = "key";
            const valInput = document.createElement("input");
            valInput.type = "text";
            valInput.name = "val";

            const domNode = document.createElement("div");
            domNode.className = "mapping";
            domNode.appendChild(keyInput);
            domNode.appendChild(valInput);

            targetDiv.appendChild(domNode);
        }

        window.addEventListener("load", function () {
            const ws = new WebSocket("wss://ws.rolsdorph.io", []);
            ws.onopen = function (event) {
                console.log("WebSocket connected, authenticating");
                ws.send(localStorage.getItem('authToken'));
            };
            ws.onmessage = function (event) {
                console.log(`Received ${event.data} over the WebSocket`);

                const data = JSON.parse(event.data);

                if (data['type'] === 'SourceCollected') {
                    const sourceId = data['sourceId'];
                    const sourceElem = document.getElementById(`source-${sourceId}`);
                    flash(sourceElem, "blue");
                } else if (data['type'] === 'SinkFed') {
                    const influxId = data['influxId'];
                    const influxElem = document.getElementById(`sink-${influxId}`);
                    flash(influxElem, "green");
                } else {
                    console.error(`Unknown event type: ${data['type']}`);
                }
            };

            const sinkForm = document.getElementById("sinkForm");
            sinkForm.addEventListener("submit", function (event) {
                event.preventDefault();
                addSink(sinkForm);
            });

            const homeForm = document.getElementById("homeForm");
            document
                .getElementById("addHomeButton")
                .addEventListener("click", function (event) {
                    event.preventDefault();
                    addHome(homeForm);
                });

            const simpleSourceForm = document.getElementById("simpleSourceForm");
            simpleSourceForm.addEventListener("submit", function (event) {
                event.preventDefault();
                addSimpleSource(simpleSourceForm);
            });

            loadHomes();
            loadSinks();
            loadSimpleSources();
        });
    </script>
</head>

<body>
    <h1>Welcome to my data page</h1>
    <h2>Add Influx target</h2>
    <form id="sinkForm">
        <label for="influxHost">Influx host:</label>
        <input type="text" name="influxHost" id="influxHost" /><br />
        <label for="influxPort">Influx port:</label>
        <input type="text" name="influxPort" id="influxPort" /><br />
        <label for="influxTLS">Use TLS:</label>
        <input type="checkbox" name="influxTLS" id="influxTLS" /><br />
        <label for="influxUsername">Influx username:</label>
        <input type="text" name="influxUsername" id="influxUsername" value="" /><br />
        <label for="influxPassword">Influx password:</label>
        <input type="password" name="influxPassword" id="influxPassword" /><br />
        <input type="submit" value="Create sink" />
    </form>

    <hr />

    <h2>Add Home</h2>
    <form id="homeForm">
        <label for="datakey">Data key:</label>
        <input type="text" name="datakey" id="datakey" />
        <input type="submit" value="Add Hue home" id="addHomeButton" />
    </form>

    <hr />

    <h2>Add Simple Source</h2>
    <form id="simpleSourceForm">
        <label for="datakey">Data key:</label>
        <input type="text" name="datakey" id="datakey" /><br />
        <label for="url">URL:</label>
        <input type="text" name="url" id="url" /><br />
        <label for="authHeader">Authorization header:</label>
        <input type="text" name="authHeader" id="authHeader" /><br />
        <h3>Tag mappings</h3>
        <div id="tagMappings">
            <div class="mappings">
                <div class="mapping">
                    <input type="text" name="key" /><input type="text" name="val" />
                </div>
            </div>
            <button onclick="addMapping(this, event)">+</button>
        </div>
        <h3>Field mappings</h3>
        <div id="fieldMappings">
            <div class="mappings">
                <div class="mapping">
                    <input type="text" name="key" /><input type="text" name="val" />
                </div>
            </div>
            <button onclick="addMapping(this, event)">+</button>
        </div>
        <br />
        <br />
        <input type="submit" value="Add source" />
    </form>

    <hr />

    <h2>Homes</h2>
    <div id="homeList"></div>

    <h2>Simple sources</h2>
    <div id="simpleSourceList"></div>

    <h2>Influxii</h2>
    <div id="influxList"></div>
</body>

</html>
