<html>

<head>
    <title>Hue Metrics Collector</title>
    <script>
        function addAuth(xhrRequest) {
            xhrRequest.setRequestHeader(
                "Authorization",
                `Bearer ${window.localStorage.getItem("authToken")}`
            );
        }

        // Performs an authenticated GET to the given URL and renders a
        // stringification of each returned element in the target div
        // (expects the GET to return a JSON list)
        function getAndRender(targetDiv, url) {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                renderJsonList(targetDiv, XHR.response);
            });

            XHR.responseType = "json";
            XHR.open("GET", url);
            addAuth(XHR);
            XHR.send();
        }

        function renderJsonList(target, elements) {
            for (const element of elements) {
                const domNode = document.createElement("div")
                domNode.innerText = JSON.stringify(element);
                target.appendChild(domNode);
            }
        }

        function loadHomes() {
            const targetDiv = document.getElementById("homeList");
            getAndRender(targetDiv, "/homes");
        }

        function loadSinks() {
            const targetDiv = document.getElementById("influxList");
            getAndRender(targetDiv, "/sinks");
        }

        function addHome() {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                if (XHR.status === 200) {
                    window.location = XHR.response;
                } else {
                    console.error(`Unexpected status code ${XHR.status}`);
                }
            });

            XHR.addEventListener("error", function (err) {
                console.log(err);
            });

            XHR.responseType = "json";
            XHR.open("POST", "/homes?redirectUrlInBody=true");
            addAuth(XHR);
            XHR.send();
        }

        function addSink(form) {
            const XHR = new XMLHttpRequest();

            XHR.addEventListener("load", function (event) {
                if (XHR.status === 201) {
                    loadSinks();
                } else {
                    console.error(`Unexpected status code ${XHR.status}`);
                }
            });

            XHR.addEventListener("error", function (err) {
                console.log(err);
            });

            XHR.responseType = "json";
            XHR.open("POST", "/sinks");
            addAuth(XHR);
            XHR.send(new FormData(form));
        }

        window.addEventListener("load", function () {
            const form = document.getElementById("sinkForm");
            form.addEventListener("submit", function (event) {
                event.preventDefault();

                addSink(form);
            });

            document
                .getElementById("addHomeButton")
                .addEventListener("click", function (event) {
                    event.preventDefault();
                    addHome();
                });

            loadHomes();
            loadSinks();
        });
    </script>
</head>

<body>
    <h1>Welcome to my data page</h1>
    <h2>Add Influx target</h2>
    <form id="sinkForm">
        <label for="influxHost">Influx host:</label>
        <input type="text" name="influxHost" id="influxHost" /><br />
        <label for="influxPort">Influx port:</label>
        <input type="text" name="influxPort" id="influxPort" /><br />
        <label for="influxTLS">Use TLS:</label>
        <input type="checkbox" name="influxTLS" id="influxTLS" /><br />
        <label for="influxUsername">Influx username:</label>
        <input type="text" name="influxUsername" id="influxUsername" value="" /><br />
        <label for="influxPassword">Influx password:</label>
        <input type="password" name="influxPassword" id="influxPassword" /><br />
        <input type="submit" value="Create sink" />
    </form>

    <h2>Add Home</h2>
    <input type="button" value="Add Hue home" id="addHomeButton" />

    <h2>Homes</h2>
    <div id="homeList"></div>

    <h2>Influxii</h2>
    <div id="influxList"></div>
</body>

</html>
